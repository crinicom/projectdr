
<script>
function submit_stk_status(select, project_id) {
    var stk_id = select.id;
    window.alert("entre a script"+stk_id+" pid"+project_id);
    $.ajax({
                    url: "/stakeholder/update_status_ajax/"+stk_id, // add appropriate action and sails.js controller here 
                    data: 'status=' + select.value+'&belongs_to_project='+project_id,
                    success: function(msg){
                        window.alert("ok:"+stk_id+msg);
                    },
                    error : function(msg){
                        window.alert("error:"+stk_id+msg);
                    }
               });
}

function assign_task(select, project_id) {
    var task_id = select.id;
    window.alert("entre a script"+task_id+" pid"+project_id);
    $.ajax({
                    url: "/task/assign_ajax/"+task_id, // add appropriate action and sails.js controller here 
                    data: 'responsible=' + select.value+'&belongs_to_project='+project_id,
                    success: function(msg){
                        window.alert("ok:"+stk_id+msg);
                    },
                    error : function(msg){
                        window.alert("error:"+stk_id+msg);
                    }
               });
}

</script>

<div id="wrapper">
        <div class="row">      
            <%- partial('../new_navbuttons.ejs') %>    
           
        </div> <!-- fin row-->
    
    <div class="row-fluid top-page">
        <% if (project.status.gantt == "wip" || project.status.gantt == "no") {%>
            <div class="alert alert-primary" role="alert">
                Recuerda<strong> asignar un responsable por tarea</strong>, marcar cada tarea como "en proceso" o "finalizada" y
                registrar comentarios de seguimiento para cada una. 
            </div>
         <%} else {%>
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <strong>¡Felicidades!</strong> ¡Este Proyecto ha sido un éxito! Recuerda recomendar esta aplicación a tus colegas.
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
            <%};%>
    
    </div>
 
 
   
   
        <div class="pull-right">
            
        </div>
       
        <div class="progress ">
            <div class="progress-bar" role="progressbar" aria-valuenow="<%=advance%>"
            aria-valuemin="0" aria-valuemax="100" style="width:<%=advance%>%">
           <h1> <%=advance%>%</h1>
            </div>
          </div>
        <hr>
        <H2>Plan de trabajo</H2>
        

<!-- /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//
// SECCIÓN DE STAKEHOLDERS
//
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->

        <table class="table table table-sm table-vcenter" id="myTable">
           <thead>
            <tr>
                <th class="align-middle" style="width: 30%">Tarea</th>
                <th class="align-middle" style="width: 15%"></th>
                <th class="align-middle" ></th>
                <th class="align-middle" ></th>
                <th class="align-middle" style="width: 50%"></th>
                
            </tr>
        </thead>
         <tbody>

        <% _.each(project.stakeholders, function(stakeholder) { %>
            <tr data-id="<%= stakeholder.id%>" data-model="stakeholder">
           
                    <td class="vert-aligned"><%=stakeholder.comm_plan%> <p style="color:rgba(95, 93, 93, 0.692);"><small><%= stakeholder.name%></small></p></td>
                    <td>
                            <form action="/stakeholder/update_status/<%=stakeholder.id%>" method="POST" id="status<%=stakeholder.id%>">
                                <div class="form-inline">
                                        <div class="form-group">
                                            
                                                <select name="status" width="100" style="width: 100px" onchange="submit()"> <!-- FUNCIONA!-->
                                                    <option value="<%=stakeholder.status%>"><%=stakeholder.status%></option>  
                                                    <option value="Pendiente">Pendiente</option>
                                                    <option value="En proceso">En proceso</option>
                                                    <option value="Finalizada">Finalizada</option>
                                                </select>
                                                <div style="display:none;">  
                                                        <input type="hidden" value="<%=project.id%>" name="belongs_to_project">
                                                        <input type="hidden" name="_csrf" value="<%= _csrf%>">
                                                </div>
                                           <!--  <button type="submit" class="btn btn-default" ><i class="fa fa-save" aria-hidden="true"></i> -->
                                            </button>
                                        </div>
                                </div>
                            </form>
                             
                    </td>
                    
                    <td> <!-- Boton que muestra un responsable-->
                        <form action="/stakeholder/update_assign/<%=stakeholder.id%>">
                            <div class="form-inline">
                                    <div class="form-group">
                                        
                                            <select name="responsible" width="100" style="width: 100px" onchange="submit()">
                                                <%if(stakeholder.responsible)  {%>
                                               
                                                    <% _.each(project.team, function(team_member) { %>
                                                        <%if(stakeholder.responsible==team_member.id)  {%> 
                                                            <option value="<%=team_member.id%>"><%=team_member.name%> <%=team_member.last_name%> </option>
                                                        <%}%>
                                                    <% });%>
                                                <%} else {%>
                                                        <option value="">no asignado</option>
                                                <%}%> 
                                                
                                                <% _.each(project.team, function(team_member) { %>
                                                <option value="<%=team_member.id%>"><%=team_member.name%> <%=team_member.last_name%> </option>  
                                                <% });%>
                                                
                                            </select>
                                            <div style="display:none;">  
                                                    <input type="hidden" value="<%=project.id%>" name="belongs_to_project">
                                                    <input type="hidden" name="_csrf" value="<%= _csrf%>">
                                            </div>
                                       <!--  <button type="submit" class="btn btn-default" ><i class="fa fa-save" aria-hidden="true"></i> -->
                                        
                                    </div>
                            </div>
                          </form>
    
    
                    </td><!-- fin de boton de responsable-->
                    
                    
                    
                  

    <!-- SECCION DE COMENTARIOS ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////-->
    <td>
            <div class="pull-right">     <!-- Botón de nuevo comentario-->
                <form action="/comment/new" method="POST">
                    <div class="control-group" style="display:none;">    
                        <input type="hidden" value="<%=project.id%>" name="belongs_to_project">
                        <input type="hidden" value="gantt" name="belongs_to">
                        <input type="hidden" value="stakeholders" name="section">
                        <input type="hidden" value="<%=stakeholder.id%>" name="item">
                        <input type="hidden" value="/project/gantt/<%=project.id%>" name="comes_from">
                        <input type="hidden" value="<%=_csrf%>" name="_csrf">
                    </div>
                    <button type="submit" class="btn btn-sm btn-success" >
                        <i class="fa fa-plus" aria-hidden="true"></i>
                    </button>
                </form>
            
            </div>
        </td> <!-- FIN botón nuevo vomentario-->
     <td>
         <table class="table table-sm table-borderless table-condensed projects-table">
            <thead>
                <th></th>
                <th></th>
            </thead>
           <tbody>
            <tr>   <!-- muestro badge y texto de último comentario cronológico, si existe-->
                  <% if (comments.filter(function thisSection(comment) { return (comment.section == 'stakeholders' && comment.item == stakeholder.id)}).length > 0) {%>
                    <td>  
                         <span class="badge badge-default">
                                <%= comments.find(function thisSection(comment) { return (comment.section == 'stakeholders' && comment.item == stakeholder.id)}).user_name %>
                        </span>
                        <%= comments.find(function thisSection(comment) { return (comment.section == 'stakeholders' && comment.item == stakeholder.id)}).text %>
                        <p style="color:rgba(184, 180, 180, 0.692);">
                            <small>
                                    <%= comments.find(function thisSection(comment) { return (comment.section == 'stakeholders' && comment.item == stakeholder.id)}).date.toLocaleString() %>      
                            </small>
                        </p>
                    
                    </td>
                    <td>  <!-- BOTON QUE DESPLIEGA COMENTARIOS: SE MUESTRA SÓLO SI HAY COMENTARIOS!! -->
                         <% if (comments.filter(function thisSection(comment) { return (comment.section == 'stakeholders' && comment.item == stakeholder.id)}).length > 0) {%>
                        <div class="pull-right"> <!-- Boton que despliega lista de comentarios históricos-->
                            <a class="btn btn-primary btn-sm" data-toggle="collapse" href="#collapse<%=stakeholder.id%>" aria-expanded="false" aria-controls="collapse<%=stakeholder.id%>">
                                    <i class="fa fa-comments" aria-hidden="true">
                                    </i> 
                                </a>
                        </div>    <!-- FIN Boton que despliega lista de comentarios históricos-->     
                    <% }%>
                  </td>
                <% } %>
            </tr> <!--FIN último comentario y botón de más comentarios-->
        
         <!--COMENTARIOS COLAPSABLES-->   
         <% if (comments.filter(function thisSection(comment) { return (comment.section == 'stakeholders' && comment.item == stakeholder.id)}).length > 0) {%>
         <tr>
            <td>
            <div class="collapse" id="collapse<%=stakeholder.id%>">
                <div class="card card-body">
                    
                    <table class="table table-sm table-borderless table-condensed">
                       <thead>
                           <th></th>
                           <th></th>
                           <th></th>
                        </thead>
                    <tbody>
                        <% _.each(comments, function(comment) { if(comment.section == 'stakeholders' && comment.item == stakeholder.id) { %>
                            <tr data-id="<%= comment.id%>" data-model="comment">
                                <td><span class="badge badge-default"><%= comment.user_name%></span>
                                    <%= comment.text%> - <p style="color:rgba(184, 180, 180, 0.692);"><small> <%= comment.date.toLocaleString()%></small></p>
                                </td>
                                <!-- <td><a href="/project/show/<%=project.id%>">Show</a></td> -->
                                <td>
                                    <form action="/comment/edit/<%= comment.id %>" method="POST">
                                    <button type="submit" class="btn btn-sm btn-success" >
                                        <i class="fa fa-pencil" aria-hidden="true"></i>
                                    </button>
                                    <div class="control-group" style="display:none;"> 
                                            <input type="hidden" name="_method" value="edit" >
                                            <input type="hidden" value="/project/gantt/<%=project.id%>" name="comes_from">
                                            <input type="hidden" name="_csrf" value="<%= _csrf%>">
                                        </div>
                                    </form> 
                                </td>
                                <td>
                                        <form action="/comment/destroy/<%= comment.id %>" method="POST">
                                            <button type="submit" class="btn btn-sm btn-danger" >
                                                <i class="fa fa-trash" aria-hidden="true"></i>
                                            </button>
                                        <div class="control-group" style="display:none;">    
                                            <input type="hidden" value="/project/gantt/<%=project.id%>" name="comes_from">
                                            <input type="hidden" name="_method" value="delete" />
                                            <input type="hidden" name="_csrf" value="<%= _csrf%>"/>
                                        </div>
                                        </form>
                                </td>
                            
                            </tr>
                        <% }}); %> <!-- fin de ciclo -->
                    </tbody>
                    </table>
                
                </div>
            </div>
        </td>
    </tr>  <!-- FIN COMENTARIOS COLAPSABLES-->  
    <% } else {%>
        <tr><td><p style="color:rgba(184, 180, 180, 0.692);"><%= __('nocomments')%></p></td></tr>
    <% } %>
    </tbody>
    </table>
    </td> <!--FIN DE COMENTARIOS ///////////////////////////////////////////////////////////////////////////////////////////////////////// -->



<!-- /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//
// SECCIÓN DE RIESGOS
//
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->


             </tr>  <% }); %>
    
       <% _.each(project.risks, function(risk) { %>
        <tr data-id="<%= risk.id%>" data-model="risk">
       
                <td class="vert-aligned"><%=risk.mitigation%> <p style="color:rgba(95, 93, 93, 0.692);"><small><%= risk.description%></small></p></td>
                <td>
                    
                        <form action="/risk/update_status/<%=risk.id%>" method="POST" id="status<%=risk.id%>">
                            <div class="form-inline">
                                    <div class="form-group">
                                        
                                            <select name="status" width="100" style="width: 100px" onchange="submit()">
                                                <option value="<%=risk.status%>"><%=risk.status%></option>  
                                                <option value="Pendiente">Pendiente</option>
                                                <option value="En proceso">En proceso</option>
                                                <option value="Finalizada">Finalizada</option>
                                            </select>
                                            <div style="display:none;">  
                                                    <input type="hidden" value="<%=project.id%>" name="belongs_to_project">
                                                    <input type="hidden" name="_csrf" value="<%= _csrf%>">
                                            </div>
                                       <!--  <button type="submit" class="btn btn-default" ><i class="fa fa-save" aria-hidden="true"></i> -->
                                        </button>
                                    </div>
                            </div>
                        </form>
                </td>
                
                <td> <!-- Boton que muestra un responsable-->
                    <form action="/risk/update_assign/<%=risk.id%>">
                        <div class="form-inline">
                                <div class="form-group">
                                    
                                        <select name="responsible" width="100" style="width: 100px" onchange="submit()">
                                            <%if(risk.responsible)  {%>
                                           
                                                <% _.each(project.team, function(team_member) { %>
                                                    <%if(risk.responsible==team_member.id)  {%> 
                                                        <option value="<%=team_member.id%>"><%=team_member.name%> <%=team_member.last_name%> </option>
                                                    <%}%>
                                                <% });%>
                                            <%} else {%>
                                                    <option value="">no asignado</option>
                                            <%}%> 
                                            
                                            <% _.each(project.team, function(team_member) { %>
                                            <option value="<%=team_member.id%>"><%=team_member.name%> <%=team_member.last_name%> </option>  
                                            <% });%>
                                            
                                        </select>
                                        <div style="display:none;">  
                                                <input type="hidden" value="<%=project.id%>" name="belongs_to_project">
                                                <input type="hidden" name="_csrf" value="<%= _csrf%>">
                                        </div>
                                   <!--  <button type="submit" class="btn btn-default" ><i class="fa fa-save" aria-hidden="true"></i> -->
                                    
                                </div>
                        </div>
                      </form>


                </td><!-- fin de boton de responsable-->
                
                
               

                 <!-- SECCION DE COMENTARIOS ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////-->
                 <td>
                        <div class="pull-right">     <!-- Botón de nuevo comentario-->
                            <form action="/comment/new" method="POST">
                                <div class="control-group" style="display:none;">    
                                    <input type="hidden" value="<%=project.id%>" name="belongs_to_project">
                                    <input type="hidden" value="gantt" name="belongs_to">
                                    <input type="hidden" value="risks" name="section">
                                    <input type="hidden" value="<%=risk.id%>" name="item">
                                    <input type="hidden" value="/project/gantt/<%=project.id%>" name="comes_from">
                                    <input type="hidden" value="<%=_csrf%>" name="_csrf">
                                </div>
                                <button type="submit" class="btn btn-sm btn-success" >
                                    <i class="fa fa-plus" aria-hidden="true"></i>
                                </button>
                            </form>
                        
                        </div>
                    </td> <!-- FIN botón nuevo vomentario-->
                 <td>
                     <table class="table table-sm table-borderless table-condensed">
                         <thead>
                             <th></th>
                             <th></th>
                            </thead>
                         <tbody>
                        <tr>   <!-- muestro badge y texto de último comentario cronológico, si existe-->
                              <% if (comments.filter(function thisSection(comment) { return (comment.section == 'risks' && comment.item == risk.id)}).length > 0) {%>
                                <td>  
                                     <span class="badge badge-default">
                                            <%= comments.find(function thisSection(comment) { return (comment.section == 'risks' && comment.item == risk.id)}).user_name %>
                                    </span>
                                    <%= comments.find(function thisSection(comment) { return (comment.section == 'risks' && comment.item == risk.id)}).text %>
                                    <p style="color:rgba(184, 180, 180, 0.692);">
                                        <small>
                                                <%= comments.find(function thisSection(comment) { return (comment.section == 'risks' && comment.item == risk.id)}).date.toLocaleString() %>      
                                        </small>
                                    </p>
                                
                                </td>
                                <td>  <!-- BOTON QUE DESPLIEGA COMENTARIOS: SE MUESTRA SÓLO SI HAY COMENTARIOS!! -->
                                     <% if (comments.filter(function thisSection(comment) { return (comment.section == 'risks' && comment.item == risk.id)}).length > 0) {%>
                                    <div class="pull-right"> <!-- Boton que despliega lista de comentarios históricos-->
                                        <a class="btn btn-primary btn-sm" data-toggle="collapse" href="#collapse<%=risk.id%>" aria-expanded="false" aria-controls="collapse<%=risk.id%>">
                                                <i class="fa fa-comments" aria-hidden="true">
                                                </i> 
                                            </a>
                                    </div>    <!-- FIN Boton que despliega lista de comentarios históricos-->     
                                <% }%>
                              </td>
                            <% } %>
                        </tr> <!--FIN último comentario y botón de más comentarios-->
                    
                     <!--COMENTARIOS COLAPSABLES-->   
                     <% if (comments.filter(function thisSection(comment) { return (comment.section == 'risks' && comment.item == risk.id)}).length > 0) {%>
                     <tr>
                        <td>
                        <div class="collapse" id="collapse<%=risk.id%>">
                            <div class="card card-body">
                                
                                <table class="table table-sm table-borderless table-condensed">
                                   <thead>
                                       <th></th>
                                       <th></th>
                                       <th></th>
                                      
                                    </thead>
                                   <tbody>
                                
                                    <% _.each(comments, function(comment) { if(comment.section == 'risks' && comment.item == risk.id) { %>
                                        <tr data-id="<%= comment.id%>" data-model="comment">
                                            <td><span class="badge badge-default"><%= comment.user_name%></span>
                                                <%= comment.text%> - <p style="color:rgba(184, 180, 180, 0.692);"><small> <%= comment.date.toLocaleString()%></small></p>
                                            </td>
                                            <!-- <td><a href="/project/show/<%=project.id%>">Show</a></td> -->
                                            <td>
                                                <form action="/comment/edit/<%= comment.id %>" method="POST">
                                                <button type="submit" class="btn btn-sm btn-success" >
                                                    <i class="fa fa-pencil" aria-hidden="true"></i>
                                                </button>
                                                <div class="control-group" style="display:none;"> 
                                                        <input type="hidden" name="_method" value="edit" >
                                                        <input type="hidden" value="/project/gantt/<%=project.id%>" name="comes_from">
                                                        <input type="hidden" name="_csrf" value="<%= _csrf%>">
                                                    </div>
                                                </form> 
                                            </td>
                                            <td>
                                                    <form action="/comment/destroy/<%= comment.id %>" method="POST">
                                                        <button type="submit" class="btn btn-sm btn-danger" >
                                                            <i class="fa fa-trash" aria-hidden="true"></i>
                                                        </button>
                                                    <div class="control-group" style="display:none;">    
                                                        <input type="hidden" value="/project/gantt/<%=project.id%>" name="comes_from">
                                                        <input type="hidden" name="_method" value="delete" />
                                                        <input type="hidden" name="_csrf" value="<%= _csrf%>"/>
                                                    </div>
                                                    </form>
                                            </td>
                                        
                                        </tr>
                                    <% }}); %> <!-- fin de ciclo -->
                                </tbody>
                                </table>
                            
                            </div>
                        </div>
                    </td>
                </tr>  <!-- FIN COMENTARIOS COLAPSABLES-->  
                <% } else {%>
                    <tr><td><p style="color:rgba(184, 180, 180, 0.692);"><%= __('nocomments')%></p></td></tr>
                <% } %>
            </tbody>
                </table>
                </td> <!--FIN DE COMENTARIOS ///////////////////////////////////////////////////////////////////////////////////////////////////////// -->



         </tr>    <% }); %>

<!-- /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//
// SECCIÓN DE TAREAS
//
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->


         <% _.each(project.objectives, function(objective) { %> 
          
            <tr data-id="<%= objective.id%>" data-model="objective">
                <td>
                <% _.each(objective.tasks, function(task) { %>
                    <%if (task.text) {%>  
                    <tr data-id="<%= task.id%>" data-model="task">
                    <td class="vert-aligned"><%=task.text%> <p style="color:rgba(95, 93, 93, 0.692);"><small><%= objective.description%></small></p>
                       
                    </td>
                     <td> <!--ESTADO DE AVANCE-->
                        <form action="/task/update_status/<%=task.id%>">
                            <div class="form-inline">
                                    <div class="form-group">
                                        
                                            <select name="status" width="100" style="width: 100px" onchange="submit()">
                                                <option value="<%=task.status%>"><%=task.status%></option>  
                                                <option value="Pendiente">Pendiente</option>
                                                <option value="En proceso">En proceso</option>
                                                <option value="Finalizada">Finalizada</option>
                                            </select>
                                            <div style="display:none;">  
                                                    <input type="hidden" value="<%=project.id%>" name="belongs_to_project">
                                            </div>
                                       <!--  <button type="submit" class="btn btn-default" ><i class="fa fa-save" aria-hidden="true"></i> -->
                                        </button>
                                    </div>
                            </div>
                          </form>
                     </td> <!--FIN ESTADO DE AVANCE-->
                    
                     <td> <!-- Boton que muestra un responsable-->
                            <form action="/task/update_assign/<%=task.id%>">
                                <div class="form-inline">
                                        <div class="form-group">
                                            
                                                <select name="responsible" width="100" style="width: 100px" onchange="submit()">
                                                    <%if(task.responsible)  {%>
                                                   
                                                        <% _.each(project.team, function(team_member) { %>
                                                            <%if(task.responsible==team_member.id)  {%> 
                                                                <option value="<%=team_member.id%>"><%=team_member.name%> <%=team_member.last_name%> </option>
                                                            <%}%>
                                                        <% });%>
                                                    <%} else {%>
                                                            <option value="">no asignado</option>
                                                    <%}%> 
                                                    
                                                    <% _.each(project.team, function(team_member) { %>
                                                    <option value="<%=team_member.id%>"><%=team_member.name%> <%=team_member.last_name%> </option>  
                                                    <% });%>
                                                    
                                                </select>
                                                <div style="display:none;">  
                                                        <input type="hidden" value="<%=project.id%>" name="belongs_to_project">
                                                        <input type="hidden" name="_csrf" value="<%= _csrf%>">
                                                </div>
                                           <!--  <button type="submit" class="btn btn-default" ><i class="fa fa-save" aria-hidden="true"></i> -->
                                            
                                        </div>
                                </div>
                              </form>


                        </td><!-- fin de boton de responsable-->
                        
                        <!-- SECCION DE COMENTARIOS ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////-->
                        <td>
                                <div class="pull-right">     <!-- Botón de nuevo comentario-->
                                    <form action="/comment/new" method="POST">
                                        <div class="control-group" style="display:none;">    
                                            <input type="hidden" value="<%=project.id%>" name="belongs_to_project">
                                            <input type="hidden" value="gantt" name="belongs_to">
                                            <input type="hidden" value="objectives" name="section">
                                            <input type="hidden" value="<%=task.id%>" name="item">
                                            <input type="hidden" value="/project/gantt/<%=project.id%>" name="comes_from">
                                            <input type="hidden" value="<%=_csrf%>" name="_csrf">
                                        </div>
                                        <button type="submit" class="btn btn-sm btn-success" >
                                            <i class="fa fa-plus" aria-hidden="true"></i>
                                        </button>
                                    </form>
                                
                                </div>
                            </td> <!-- FIN botón nuevo vomentario-->
                         <td>
                             <table class="table table-sm table-borderless table-condensed projects-table">
                                 <thead><th></th>
                                    <th></th>
                                </thead>
                                 <tbody>
                                <tr>   <!-- muestro badge y texto de último comentario cronológico, si existe-->
                                      <% if (comments.filter(function thisSection(comment) { return (comment.section == 'objectives' && comment.item == task.id)}).length > 0) {%>
                                        <td>  
                                             <span class="badge badge-default">
                                                    <%= comments.find(function thisSection(comment) { return (comment.section == 'objectives' && comment.item == task.id)}).user_name %>
                                            </span>
                                            <%= comments.find(function thisSection(comment) { return (comment.section == 'objectives' && comment.item == task.id)}).text %>
                                            <p style="color:rgba(184, 180, 180, 0.692);">
                                                <small>
                                                        <%= comments.find(function thisSection(comment) { return (comment.section == 'objectives' && comment.item == task.id)}).date.toLocaleString() %>      
                                                </small>
                                            </p>
                                        
                                        </td>
                                        <td>  <!-- BOTON QUE DESPLIEGA COMENTARIOS: SE MUESTRA SÓLO SI HAY COMENTARIOS!! -->
                                             <% if (comments.filter(function thisSection(comment) { return (comment.section == 'objectives' && comment.item == task.id)}).length > 0) {%>
                                            <div class="pull-right"> <!-- Boton que despliega lista de comentarios históricos-->
                                                <a class="btn btn-primary btn-sm" data-toggle="collapse" href="#collapse<%=task.id%>" aria-expanded="false" aria-controls="collapse<%=task.id%>">
                                                        <i class="fa fa-comments" aria-hidden="true">
                                                        </i> 
                                                    </a>
                                            </div>    <!-- FIN Boton que despliega lista de comentarios históricos-->     
                                        <% }%>
                                      </td>
                                    <% } %>
                                </tr> <!--FIN último comentario y botón de más comentarios-->
                            
                             <!--COMENTARIOS COLAPSABLES-->   
                             <% if (comments.filter(function thisSection(comment) { return (comment.section == 'objectives' && comment.item == task.id)}).length > 0) {%>
                             <tr>
                                <td>
                                <div class="collapse" id="collapse<%=task.id%>">
                                    <div class="card card-body">
                                        
                                        <table class="table table-sm table-borderless table-condensed">
                                           <thead><th></th>
                                            <th></th>
                                            <th></th></thead>
                                        <tbody>
                                            <% _.each(comments, function(comment) { if(comment.section == 'objectives' && comment.item == task.id) { %>
                                                <tr data-id="<%= comment.id%>" data-model="comment">
                                                    <td><span class="badge badge-default"><%= comment.user_name%></span>
                                                        <%= comment.text%> - <p style="color:rgba(184, 180, 180, 0.692);"><small> <%= comment.date.toLocaleString()%></small></p></td>
                                                    <!-- <td><a href="/project/show/<%=project.id%>">Show</a></td> -->
                                                    <td>
                                                        <form action="/comment/edit/<%= comment.id %>" method="POST">
                                                        <button type="submit" class="btn btn-sm btn-success" >
                                                            <i class="fa fa-pencil" aria-hidden="true"></i>
                                                        </button>
                                                        <div class="control-group" style="display:none;"> 
                                                                <input type="hidden" name="_method" value="edit" >
                                                                <input type="hidden" value="/project/gantt/<%=project.id%>" name="comes_from">
                                                                <input type="hidden" name="_csrf" value="<%= _csrf%>">
                                                            </div>
                                                        </form> 
                                                    </td>
                                                    <td>
                                                            <form action="/comment/destroy/<%= comment.id %>" method="POST">
                                                                <button type="submit" class="btn btn-sm btn-danger" >
                                                                    <i class="fa fa-trash" aria-hidden="true"></i>
                                                                </button>
                                                            <div class="control-group" style="display:none;">    
                                                                <input type="hidden" value="/project/gantt/<%=project.id%>" name="comes_from">
                                                                <input type="hidden" name="_method" value="delete" />
                                                                <input type="hidden" name="_csrf" value="<%= _csrf%>"/>
                                                            </div>
                                                            </form>
                                                    </td>
                                                
                                                </tr>
                                            <% }}); %> <!-- fin de ciclo -->
                                            </body>    
                                        </table>
                                    
                                    </div>
                                </div>
                            </td>
                        </tr>  <!-- FIN COMENTARIOS COLAPSABLES-->  
                        <% } else {%>
                            <tr><td><p style="color:rgba(184, 180, 180, 0.692);"><%= __('nocomments')%></p></td></tr>
                        <% } %>
                       </tbody>
                        </table>
                        </td> <!--FIN DE COMENTARIOS ///////////////////////////////////////////////////////////////////////////////////////////////////////// -->
                    </tr>

                    <%}%>
                        <% }); %> <!--fin ciclo tareas-->
                    </td>   
            </tr>
            
              <% }); %> <!--fin ciclo objetivos-->
    
            </tbody>
        </table> <!-- cierre tabla grande-->
    

        
    
    
    </div>